## 前言
去广州某知名二线互联网面试，面试官看到我项目中用到了redis，便问到redis针对过期键是怎么删除的。以前没
看过这方面的内容，回家研究了下。

## 删除策略
### 定时删除

这个策略理解起来比较简单，就是每设置一个过期键，就给这个键设置一个定时器，当这个键过期的时候，这个定时器就能及时把过期键的删除。这也是我面试的时候凭自己的想法提出的，因为当时真没看过redis是如何处理过期键的。但这个策略有一个很大问题，就是对CPU十分不友好。如果有成千上万个过期键，会占用大量的CPU时间，这个策略
redis其实是没有使用的。
redis针对过期键采用的是如下的两种策略

### 惰性删除
惰性删除就是不主动去删除过期键，而是在客户端每次获取键值得时候先判断键有没有过期，过期了返回空，没过期
再去查找键的值。
惰性删除对CPU是十分有好的，不会占用过多的CPU时间，但却存在另外一个漏洞。如果一个键设置了过期时间后，
一直没有客户端去获取这个键，那么这个键就会一直存在。我们知道Redis是基于内存的，如果有大量这样键的存在
，势必会造成内存的浪费。
### 定期删除
为了解决过期键一直存在的问题，Redis加上了一个定期删除的策略。定期删除策略会每次选择一个数据库，从redis
的过期键中随机选择一个判断键是否过期。它每次处理固定的时间，时间到就停止。

## AOF RDB对过期键的处理
### RDB 过期键处理
每次执行SAVA 或者BGSAVE命令生成RDB 文件，都会检查过期键，过期的键不会被保存下来。
在载入RDB文件的时候，分两种情况。
* 如果是主服务器，则每次都会检查过期键。
* 如果是从服务器，则不会做过期键的处理。但从主服务器同步数据的时候，从服务器的数据就会被清空，所以过期
键也不会对数据造成影响。

### AOF 过期键
AOF 数据库中的键过期不会影响AOF文件，但过期键被定期删除或者惰性删除后，会在文件末尾添加一天DEL命令。
AOF 重写则不会保存过期的键到AOF文件中。

通过 AOF 和 RDB对过期键的处理我们可以看到，其实惰性删除能够保证客户端不会读到过期的数据。RDB和AOF针对
过期键的处理更多是因为性能的考虑，通过处理可以使得RDB和AOF文件不至于过大，加速启动时数据的载入。

## 复制过期键处理
当服务器以复制模式运行时，从服务器不会主动的去删除过期键，所有过期键的删除都有主服务器处理。这就可能导致
从从服务器可以获取到过期的键。
